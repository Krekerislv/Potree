<!DOCTYPE html><html lang="en"><head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="/build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="/libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="/libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="/libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="/libs/jstree/themes/mixed/style.css">
	
	
	<style>
	
		#potree_toolbar{
			position: absolute; 
			z-index: 10000; 
			left: 100px; 
			top: 0px;
			background: black;
			color: white;
			padding: 0.3em 0.8em;
			font-family: "system-ui";
			border-radius: 0em 0em 0.3em 0.3em;
			display: flex;
		}
	
		.potree_toolbar_label{
			text-align: center;
			font-size: smaller;
			opacity: 0.9;
		}
	
		.potree_toolbar_separator{
			background: white;
			padding: 0px;
			margin: 5px 10px;
			width: 1px;
		}
		
	</style>


</head>

<body>
	<script id="cloud_vars_script" src="pointclouds/cloud_vars.js"></script>
	<script>
		var cloudNames = [];
		for (let path of cloudPaths) {
			let tmpArr = path.split("/");
			cloudNames.push(tmpArr[tmpArr.length-2]);
		}
		
	</script>

	<script src="/libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="/libs/spectrum/spectrum.js"></script>
	<script src="/libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="/libs/other/BinaryHeap.js"></script>
	<script src="/libs/tween/tween.min.js"></script>
	<script src="/libs/d3/d3.js"></script>
	<script src="/libs/proj4/proj4.js"></script>
	<script src="/libs/openlayers3/ol.js"></script>
	<script src="/libs/i18next/i18next.js"></script>
	<script src="/libs/jstree/jstree.js"></script>
	<script src="/build/potree/potree.js"></script>
	<script src="/libs/plasio/js/laslaz.js"></script>
	<script type="module" src="/libs/PCsplit/Cloud_Split_main.js"></script>
	
	
	<div class="potree_container" style="position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
		<div id="potree_render_area" style="background-image: url('/build/potree/resources/images/background.jpg');">
			<div id="potree_toolbar"></div>
		</div>
		<div id="potree_sidebar_container"> </div>
	</div>
	


	<script type="module">

	import * as THREE from "/libs/three.js/build/three.module.js";

		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
		
		viewer.setEDLEnabled(true);
		viewer.setFOV(40);
		viewer.loadSettingsFromURL();
		viewer.useHQ = true;
		viewer.setPointBudget(10*1000*1000);
		viewer.toggleSidebar();
		viewer.setDescription("Point Cloud");
		viewer.minNodeSize = 0;
		
		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_tools").next().show();
			
			let section = $(`
        	<h3 id="menu_meta" class="accordion-header ui-widget"><span>Split Cloud</span></h3>
        	<div class="SplitCloud_toolbar"></div>
			`);
			let content = section.last();

			content.html(`
			<div class="SplitCloud">
				
				<p>Choose splitting plane</p>
				<input type="radio" id="XY" name="planeChoice" value="XY">
				<label for="XY">XY</label>
				<input type="radio" id="XZ" name="planeChoice" value="XZ">
				<label for="XZ">XZ</label>
				<input type="radio" id="YZ" name="planeChoice" value="YZ">
				<label for="YZ">YZ</label>

				<button id="btnAddPlane" disabled="true" >+</button>
				<button id="btnClear" disabled="true" >Clear all</button>
				<br><br>
				<label id="coordLabel" for="coordinate"></label>
				<input type="text" id="coordinateInput" name="coordinate" style="display:none;" >

				<br><br>
				<button id="btnRemovePlane" disabled="true">Delete selected plane</buton>
				
				<button id="btnSplit" disabled="true">Split Cloud</button>
				<br>
				<ul id="splitPlaneList">
				</ul>
				<a id="potree_download_split_cloud" style="display: none;" href="" download="">here</a>	
				<a target="_blank" id="btnNewCloud" style="display: none;"><button>View split cloud</button></a>
				<a id="btnDwnldCloud" style="display: none;"><button id="btnDwnldCloud_btn" >Download split cloud</button></a>
				<br>
				<p id="prepare_anim" style="color:cyan; font-size:20px; display:none;">Preparing archive</p>
				
				
			</div>
			
			`);
			section.first().click(() => content.slideToggle());
			section.insertBefore($('#menu_about'));

			});

		
		let defaultGradient = "RAINBOW";
		//Load point clouds
		for (let i=0; i<cloudPaths.length; i++) {
			Potree.loadPointCloud(cloudPaths[i], cloudNames[i], c => {
			let pointcloud = c.pointcloud;
			if (i != 0) pointcloud.visible = false; // hide all but 1st cloud
			let material = pointcloud.material;

			viewer.scene.addPointCloud(pointcloud);

			material.pointSizeType = Potree.PointSizeType.FIXED;
			
			material.activeAttributeName = "elevation";
			
			material.gradient = Potree.Gradients[defaultGradient];
			viewer.fitToScreen();
		});
		
		}
		
	</script>

	<script>

		//The following code has been adapted from Potree example
		const elToolbar = $("#potree_toolbar");

			//Add html to display cloud and gradient selection menus
			elToolbar.html(`
			<style>
				.toolbar_btn {
					display: inline;
					position: static;
					margin-top: 0.5em;
					margin-left: 0.1em;
					width: 5em;
				}

			</style>
			<span>
				<div class="potree_toolbar_label" style="width: 12em">
						Data set
				</div>
				<div>
						<select id="optCloud" name="optCloud"></select>
				</div>
			</span>


			<span class="potree_toolbar_separator"></span>
				<span>
					<div class="potree_toolbar_label">
						Gradient
					</div>
					<div>
						<span name="gradient_schemes"></span>
					</div>
				</span>
			
			<span class="potree_toolbar_separator"></span>
			<span>
			<div class="potree_toolbar_label">
						Gradient On/Off
					</div>
				<div>
					<div>
						<button id="apply_gradient" class="toolbar_btn">Disable</button>
					</div>
				</div>
			</span>

			<span class="potree_toolbar_separator"></span>
			<span>
			<div class="potree_toolbar_label">
						Flip Vertical Axis
					</div>
				<div>
					<div>
						<button id="btnFlipVertical" class="toolbar_btn">Flip Z</button>
					</div>
				</div>
			</span>
			`);
		

		{// GRADIENT
			const schemes = Object.keys(Potree.Gradients).map(name => ({name: name, values: Potree.Gradients[name]}));
			const elGradientSchemes = elToolbar.find("span[name=gradient_schemes]");

			for(const scheme of schemes){
				const elButton = $(`
					<span style=""></span>
				`);

				const svg = Potree.Utils.createSvgGradient(scheme.values);
				svg.setAttributeNS(null, "class", `button-icon`);
				svg.style.height = "2em";
				svg.style.width = "1.3em";

				elButton.append($(svg));

				let CloudSelection = elToolbar.find('#optCloud');
				
				elButton.click( () => {
					let selectedValue = CloudSelection.selectmenu().val();
					for(const pointcloud of viewer.scene.pointclouds){
						if (selectedValue.localeCompare(pointcloud.name) == 0) {
							pointcloud.material.gradient = Potree.Gradients[scheme.name];
						}
					}
				});

				elGradientSchemes.append(elButton);
			}
			const BtnGradientEnable = document.getElementById("apply_gradient");
			BtnGradientEnable.addEventListener("click", () => {
				for(const pointcloud of viewer.scene.pointclouds){
					if (BtnGradientEnable.innerHTML == "Disable") {
						pointcloud.material.activeAttributeName = "classification";
					} else {
						pointcloud.material.activeAttributeName = "elevation";
					}
				}
				BtnGradientEnable.innerHTML = BtnGradientEnable.innerHTML == "Disable" ? "Enable" : "Disable";
			});
		}


		//FLIP Z BUTTON
		{
			const btnFlipZ = document.getElementById("btnFlipVertical");
			btnFlipZ.addEventListener("click", () => {
				viewer.scene.cameraP.scale.y = -viewer.scene.cameraP.scale.y;
				viewer.orbitControls.flipVertical = !viewer.orbitControls.flipVertical;
			});
		}
	</script>

	<script type="module">
		// Change amount of clusters visible under "Filters" to match cluster count of cloud

		// Method from https://stackoverflow.com/questions/5525071/how-to-wait-until-an-element-exists
		async function waitForElm(selector) {
			return new Promise(resolve => {
				if (document.querySelector(selector)) {
					return resolve(document.querySelector(selector));
				}
				const observer = new MutationObserver(mutations => {
					if (document.querySelector(selector)) {
						resolve(document.querySelector(selector));
						observer.disconnect();
					}
				});
				observer.observe(document.body, {
					childList: true,
					subtree: true
				});
			});    
		}

		async function get_metadata(metadata_path) {
			let response = await fetch(metadata_path);
            let metadata = await response.json();
			return metadata;
		}

		const observer = new MutationObserver(() => {
			// This is executed whenever the combination of point clouds is displayed changes

			let max_cluster_count = 0;
			// Loop through all clouds to find the one that's visible
			// If multiple clouds are visible, choose the one with more clusters
			cloudPaths.forEach((metadata_path) => {
				get_metadata(metadata_path).then(metadata => {
					// get cloud name
					let tmpArr = metadata_path.split("/");
					let cloud_name = tmpArr[tmpArr.length-2];

					// get number of clusters
					let classif_atr_ind = 0;
					for (let i=0; i< metadata.attributes.length; i++) {
						if (metadata.attributes[i].name === "classification") {
							classif_atr_ind = i;
						}
					}

					let cluster_count = 1;
					for (let i=0; i < 254; i++) {
						if (metadata.attributes[classif_atr_ind].histogram[i] != 0) cluster_count = i+1
					}
					
					// find index of target cloud
					const index = viewer.scene.pointclouds.findIndex(element => element.name === cloud_name);

					if (viewer.scene.pointclouds[index].visible && cluster_count > max_cluster_count) {
				
						max_cluster_count = cluster_count;
						if (max_cluster_count > 255) max_cluster_count = 255;

						// After max_clusters has been set;
						let classifications = {};

						classifications[255] = {
							color: [127/255, 127/255, 127/255, 1], // r/255, g/255, b/255, some value idk
							name:"noise",
							visible:true
						};

						const frequency = 0.2; // Adjust this to change the frequency of the sine wave
						
						for (let i=0; i<max_cluster_count; i++) {
							
							const r = Math.abs(Math.sin(frequency * i));
							const g = Math.abs(Math.sin(frequency * i + 2 * Math.PI / 3));
							const b = Math.abs(Math.sin(frequency * i + 4 * Math.PI / 3));
					
							classifications[i] = {
								color: [r,g,b,1],
								name:"cluster_"+i,
								visible:true
							}
						}
						viewer.setClassifications(classifications);
						document.getElementById("classificationList").prepend(document.getElementById("chkClassification_255").parentElement.parentElement)
						document.getElementById("classificationList").prepend(document.getElementById("toggleClassificationFilters").parentElement.parentElement)
					}
				});
			});
		});
		const target = await waitForElm("#jstree_scene");
		observer.observe(target, { attributes: true, childList: true, subtree: true });
	</script>

</body></html>